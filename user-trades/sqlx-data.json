{
  "db": "PostgreSQL",
  "5a9db87bf5dedca40ac46fcb0c4e1288e34efc233c6882dc516095d009bb8000": {
    "describe": {
      "columns": [],
      "nullable": [],
      "parameters": {
        "Left": [
          "Numeric",
          "Int4",
          "Int4"
        ]
      }
    },
    "query": "UPDATE user_trade_balances SET current_balance = $1, last_trade_idx = $2, updated_at = now() WHERE unit_id = $3"
  },
  "7ee9a260e82cb65b8120cdfd6ca88f8cefab9a2904ef82dfa4dc027fbd7aa7bf": {
    "describe": {
      "columns": [
        {
          "name": "unit_id",
          "ordinal": 0,
          "type_info": "Int4"
        },
        {
          "name": "current_balance",
          "ordinal": 1,
          "type_info": "Numeric"
        },
        {
          "name": "last_trade_idx",
          "ordinal": 2,
          "type_info": "Int4"
        }
      ],
      "nullable": [
        false,
        false,
        true
      ],
      "parameters": {
        "Left": []
      }
    },
    "query": "SELECT unit_id, current_balance, last_trade_idx FROM user_trade_balances"
  },
  "9afafd1fc5d1bc1130b130a1c94cad02eba9ead36564e2b5962cd56d0a9fce66": {
    "describe": {
      "columns": [
        {
          "name": "id",
          "ordinal": 0,
          "type_info": "Int4"
        },
        {
          "name": "name",
          "ordinal": 1,
          "type_info": "Varchar"
        }
      ],
      "nullable": [
        false,
        false
      ],
      "parameters": {
        "Left": []
      }
    },
    "query": "SELECT id, name FROM user_trade_units"
  },
  "a2cf963eccc9b302786660107bb50d5d5f0ba3d9ccbf85684f49f35d07bc1294": {
    "describe": {
      "columns": [
        {
          "name": "idx",
          "ordinal": 0,
          "type_info": "Int4"
        }
      ],
      "nullable": [
        false
      ],
      "parameters": {
        "Left": [
          "Uuid",
          "Int4",
          "Numeric",
          "Int4",
          "Numeric"
        ]
      }
    },
    "query": "INSERT INTO user_trades (uuid, buy_unit_id, buy_amount, sell_unit_id, sell_amount) VALUES ($1, $2, $3, $4, $5) RETURNING idx"
  },
  "c198a77cbfdbd8c53702b6e24850a657cca2fd92170f5d650c6e585e412e5b3a": {
    "describe": {
      "columns": [
        {
          "name": "last_trade_idx",
          "ordinal": 0,
          "type_info": "Int4"
        }
      ],
      "nullable": [
        true
      ],
      "parameters": {
        "Left": []
      }
    },
    "query": "SELECT last_trade_idx FROM user_trade_balances FOR UPDATE"
  },
  "e626b2f91b8017e3a0ea50b5ae1646007f2a6fc9d608cbcc357108a7f5d534cc": {
    "describe": {
      "columns": [
        {
          "name": "unit_id",
          "ordinal": 0,
          "type_info": "Int4"
        },
        {
          "name": "new_balance",
          "ordinal": 1,
          "type_info": "Numeric"
        },
        {
          "name": "new_latest_idx",
          "ordinal": 2,
          "type_info": "Int4"
        }
      ],
      "nullable": [
        false,
        null,
        null
      ],
      "parameters": {
        "Left": [
          "Int4"
        ]
      }
    },
    "query": " WITH amounts AS (\n   SELECT MAX(idx) as latest_idx, buy_unit_id, SUM(buy_amount) AS to_sub, sell_unit_id, SUM(sell_amount) AS to_add \n   FROM user_trades\n   WHERE idx > $1\n   GROUP BY GROUPING SETS ((buy_unit_id), (sell_unit_id))\n )\nSELECT\n  unit_id,\n  current_balance + COALESCE(sell_amounts.to_add, 0) - COALESCE(buy_amounts.to_sub, 0) AS new_balance,\n  MAX(GREATEST(sell_amounts.latest_idx, buy_amounts.latest_idx)) OVER () AS new_latest_idx\nFROM user_trade_balances\nLEFT JOIN amounts buy_amounts ON unit_id = buy_amounts.buy_unit_id\nLEFT JOIN amounts sell_amounts ON unit_id = sell_amounts.sell_unit_id;\n"
  }
}